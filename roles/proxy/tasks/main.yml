---
- name: Configure iptables rules for proxy ports
  ansible.builtin.iptables:
    chain: "{{ item.chain }}"
    protocol: "{{ item.protocol }}"
    source: "{{ item.source | default(omit) }}"
    destination_port: "{{ item.dport }}"
    jump: "{{ item.jump }}"
    action: "{{ item.action | default(omit) }}"
  loop:
    - { chain: "DOCKER-USER", protocol: "tcp", dport: "{{ socks_port }}", jump: "DROP", action: "insert" }
    - { chain: "DOCKER-USER", protocol: "udp", dport: "{{ socks_port }}", jump: "DROP", action: "insert" }
    - { chain: "DOCKER-USER", protocol: "tcp", dport: "{{ socks_port }}", source: "{{ allowed_network }}", jump: "ACCEPT", action: "insert" }
    - { chain: "DOCKER-USER", protocol: "udp", dport: "{{ socks_port }}", source: "{{ allowed_network }}", jump: "ACCEPT", action: "insert" }
  notify: Save iptables rules

- name: Create proxy directory
  ansible.builtin.file:
    path: /opt/proxy
    state: directory
    mode: "0755"
    owner: drunner
    group: drunner

- name: Copy docker-compose file
  ansible.builtin.template:
    src: proxy.yaml.j2
    dest: /opt/proxy/proxy.yaml
    mode: "0644"
    owner: drunner
    group: drunner

- name: Copy secrets
  ansible.builtin.copy:
    src: .env
    dest: /opt/proxy/.env
    mode: "0600"
    owner: drunner
    group: drunner

- name: Start proxy service
  become_user: drunner
  community.docker.docker_compose_v2:
    project_src: /opt/proxy
    files:
      - proxy.yaml
    state: present

