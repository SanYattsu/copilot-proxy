---
- name: Create panel directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
    owner: drunner
    group: drunner
  loop:
    - /opt/panel
    - "{{ panel_db_dir }}"
    - "{{ panel_certs_dir }}"

- name: Generate CA private key
  community.crypto.openssl_privatekey:
    path: "{{ panel_certs_dir }}/ca_root.key"
    size: 2048
    mode: "0600"

- name: Generate CA CSR
  community.crypto.openssl_csr:
    path: "{{ panel_certs_dir }}/ca_root.csr"
    privatekey_path: "{{ panel_certs_dir }}/ca_root.key"
    country_name: EN
    organization_name: Nobody
    common_name: Nobody
    basic_constraints:
      - "CA:TRUE"
    basic_constraints_critical: true

- name: Generate CA certificate
  community.crypto.x509_certificate:
    path: "{{ panel_certs_dir }}/ca_root.crt"
    csr_path: "{{ panel_certs_dir }}/ca_root.csr"
    privatekey_path: "{{ panel_certs_dir }}/ca_root.key"
    provider: selfsigned
    selfsigned_not_after: "+3650d"

- name: Generate panel private key
  community.crypto.openssl_privatekey:
    path: "{{ panel_certs_dir }}/panel.key"
    size: 2048
    mode: "0600"

- name: Generate panel CSR
  community.crypto.openssl_csr:
    path: "{{ panel_certs_dir }}/panel.csr"
    privatekey_path: "{{ panel_certs_dir }}/panel.key"
    country_name: EN
    organization_name: Nobody
    common_name: Nobody

- name: Sign panel certificate with CA
  community.crypto.x509_certificate:
    path: "{{ panel_certs_dir }}/panel.crt"
    csr_path: "{{ panel_certs_dir }}/panel.csr"
    privatekey_path: "{{ panel_certs_dir }}/panel.key"
    ownca_path: "{{ panel_certs_dir }}/ca_root.crt"
    ownca_privatekey_path: "{{ panel_certs_dir }}/ca_root.key"
    ownca_not_after: "+3650d"
    provider: ownca

- name: Configure iptables rules for panel ports
  ansible.builtin.iptables:
    chain: "{{ item.chain }}"
    protocol: tcp
    source: "{{ item.source | default(omit) }}"
    destination_port: "{{ item.dport }}"
    jump: "{{ item.jump }}"
    action: "{{ item.action | default(omit) }}"
  loop:
    - { chain: "DOCKER-USER", dport: "{{ panel_http_port }}", jump: "DROP", action: "insert" }
    - { chain: "DOCKER-USER", dport: "{{ panel_xray_port }}", jump: "DROP", action: "insert" }
    - { chain: "DOCKER-USER", dport: "{{ panel_http_port }}", source: "{{ allowed_network }}", jump: "ACCEPT", action: "insert" }
    - { chain: "DOCKER-USER", dport: "{{ panel_xray_port }}", source: "{{ allowed_network }}", jump: "ACCEPT", action: "insert" }
  notify: Save iptables rules

- name: Copy panel docker-compose file
  ansible.builtin.template:
    src: panel.yaml.j2
    dest: /opt/panel/panel.yaml
    mode: "0644"
    owner: drunner
    group: drunner

- name: Start panel service
  become_user: drunner
  community.docker.docker_compose_v2:
    project_src: /opt/panel
    files:
      - panel.yaml
